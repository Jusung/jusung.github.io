---
layout: post
title: "앱 푸스란? (APNS, Remote Push)"
tags: [iOS]
comments: true
---

이 포스트에서는 iOS의 Remote Push에 대해 알아 보겠습니다.

이 포스트는 Remote Push에 대한 전체 구조에 초점이 맞춰져 있어 관련한 구체적 코드 및 Local Push에 대해서는 다루지 않습니다. Push 관련 코드와 Local Push에 대해 궁금하신 분은 [애플 문서](https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/index.html#//apple_ref/doc/uid/TP40008194-CH3-SW1)를 참조하시면 될 것 같습니다.

## iOS 앱 푸시란?
iOS 앱 푸시란? **APNs**(**A**pple **P**ush **N**otification **S**ervice)를 통해 **(1) 특정 기기**의 **(2) 특정 앱**에 **알림을 보내는 기능**입니다. 앱 푸시를 이용하면 앱이 백그라운드에서 돌 때도 깨울 수 있습니다.

## 전체 구조
iOS 앱 푸시가 동작하는 전체 구조를 살펴보면 다음과 같습니다.

![App Push1]({{ site.url }}/images/2018/app push1.jpg)

## 구성요소
1. **Provider(Push 서버)** : 애플의 APNS서버로 특정 디바이스들의 앱에게 푸시 메시지를 보내달라고 요청하는 역할의 전용 서버.

2. **APNs 서버** :  iOS 장치로 푸시 메시지를 보내는 애플 클라우드 서버 (우리가 직접 통제할 수 없음)

3. **기기 + 앱** : 푸시를 전달 받을 특정 기기에 설치된 앱

Push 발송은 그림에서 보시다시피 **Provider**가 **APNs**에게 요청함으로써 이루어집니다. 그렇다면 **Provider**가 Push 요청을 하기 위해 필요한 정보는 무엇일까요?
그것은 바로 푸시 발송 **(1) 대상 디바이스**와 **(2) 대상 앱** 두 가지입니다.

이 두가지 정보를 담고 있는 것을 **디바이스 토큰**이라고 합니다. **디바이스 토큰**은 애플에 의해 암호화 돼 전달된 64바이트 문자열로 **(1) 기기의 식별자**와 **(2) 앱 식별자**가 담겨져 있습니다.

그렇다면 **Provider**는 **디바이스 토큰**을 어떻게 얻을까요?

![App Push2]({{ site.url }}/images/2018/app push2.jpg)

**Provider**에서 **디바이트 토큰**을 얻었으니 이제 **APNs**에게  Push 요청을 할 수 있을까요? No!!! 그렇지 않습니다.
이런 상황을 가정 해보죠. 만약 아무나 내 기기의 특정앱에 푸쉬를 보낼 수 있다면 어떻게 될까요? 해커 Provider가 특정 앱을 가장해 APNs에 푸쉬를 요청한다면 무슨 일이 발생할까요?

> “(해커 Provider가 보낸) 국민은행 앱 푸시 : 국민은행입니다. 이 상품 가입하세요. 대박이에용~ ^^”
> -> 알고보니 피싱!!!

위 예에서 보시다 시피 Push는 보안이 정말 중요합니다. 그렇기 때문에 보안 관련 절차가 까다롭습니다.

그렇다면  **APNs**는 어떻게 신뢰할 만한 **Provider**인지 확인할까요?
**APNs**는 이를 **SSL**(TLS:Transport Level Security)을 이용해 해결합니다.
**Provider**와 **APNs**간의 통신을 하기 위해서는 이 **Provider**가 신뢰할 만한 놈인지를 **APNs**에게 보증해주는 인증서가 필요합니다.

그래서 **Provider**는 인증서 파일  ***.p12** 파일 혹은 ***.pem**파일을 갖고 이것을 **APNs**에게 던짐으로 **APNs**으로 부터 신뢰성을 확인 받을 수 있습니다.

- ***.p12 파일** : 인증서(Public Key가 포함 된) + Private Key를 포함 (X.509를 지원하는 파일 포맷 중에 유일하게 Private Key를 같이 넣을 수 있는 포맷)

- ***.pem 파일** : 인증서(Public Key가 포함 된)만 있는 파일

이제 **APNs**에 **Provider**가 Push를 요청하기 위해 필요한 것에 대해 전부 알았습니다.

1. **디바이스 토큰** : 특정 기기 + 특정 앱의 식별자
2. **인증서 파일** : **APNs**과 통신하기 위해 (APNs 신뢰성을 확인 받기 위해)

사실 여기까지 이해하고 사용해도 되지만, 우리는 아직 위 인증서가 어떻게 생긴 놈이고 보다 구체적으로 왜 필요한 놈인지 완전히 이해하지 못했습니다. 완전히 이해하고 싶으신 분은 2편을 기대해 주세요.

2편에는 SSL에 관한 내용과 앱에서 인증서를 만드는 내용이 포함됩니다. 보안과 관련해서 아시는 분은 건너 뛰셔도 됩니다. 만약 저 같이 대학 수업시간에 쿨쿨... 잠을 자신 분은 이번 기회에 확실히 하고 가시는 것도 좋을 것 같습니다. 😁

이상으로 iOS 앱 푸시에 대해 알아 보았습니다.
